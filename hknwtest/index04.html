<!DOCTYPE html>
<html><head>
<meta http-equiv='Content-Type' content="text/html; charset=UTF-8">
<script type="text/javascript" src="Engine3d.js"></script>
<script type="text/javascript" src="Controller.js"></script>
<script type="text/javascript" src="Character.js"></script>
<script type="text/javascript" src="Sphia.js"></script>
<script type="text/javascript">

// ----------------------------------------------------------------
// ----------------------------------------------------------------
// ----------------------------------------------------------------

// グローバル変数
var e3d = new Engine3d();
var sphia = new Sphia();
var ctrl = new Controller();
var character = new BillballCharacter();
var player = new Player();
var pmat = new Matrix();
var wmat = new Matrix();
var mat1 = new Matrix();
var mat2 = new Matrix();

// テクスチャ
var ctrlTexture;
var playerTexture;

// ----------------------------------------------------------------
// ----------------------------------------------------------------
// ----------------------------------------------------------------

window.onload = function(){
	// 初期化
	var canvas = document.getElementById("screen");
	e3d.init(canvas);
	ctrl.init(e3d, canvas);
	sphia.init(e3d);
	character.init(e3d);
	player.init();
	ctrlTexture = e3d.loadTexture("ctrl.png");
	playerTexture = e3d.loadTexture("player.png");
	
	pmat.frustum(0.1, 0.1, 0.1, 100);
	
	// 初期視点設定
	ctrl.rotv = 0;
	ctrl.roth = Math.PI / 180 * 20;
	ctrl.roth_max = Math.PI / 180 * 60;
	ctrl.roth_min = Math.PI / 180 * 10;
	ctrl.distance = 1;
	
	// 描画処理を毎秒 30 回呼び出す
	setInterval(redrawScene, 1000 / 30);
}

// ----------------------------------------------------------------
// ----------------------------------------------------------------
// ----------------------------------------------------------------

// メインループ
function redrawScene(){
	// 計算
	player.calc(mat1);
	
	// ----------------------------------------------------------------
	// 3D描画
	e3d.clear();
	e3d.setDepthMode(true);
	e3d.setAlphaMode(0);
	// カメラ
	mat2.identity();
	mat2.mulTranslate(0, -1, -0.65 * ctrl.distance);
	mat2.mulTranslate(0, player.height, 0);
	mat2.mulRotX(ctrl.roth);
	mat2.mulTranslate(0, -player.height, 0);
	mat2.mulRotY(ctrl.rotv);
	wmat.mul(mat1, mat2);
	mat1.mul(wmat, pmat);
	// キャラクター
	e3d.bindTex(playerTexture, 0);
	player.draw(character, e3d, wmat, pmat);
	// マップ
	sphia.draw(e3d, mat1);
	
	// ----------------------------------------------------------------
	// 2D描画
	e3d.setDepthMode(false);
	e3d.setAlphaMode(0);
	mat1.ortho(0, 0, ctrl.w, ctrl.h);
	// コントローラ
	e3d.bindTex(ctrlTexture, 0);
	ctrl.draw(e3d, mat1);
	
	// ----------------------------------------------------------------
	// ページに反映させる
	e3d.flush();
}

// ----------------------------------------------------------------
// ----------------------------------------------------------------
// ----------------------------------------------------------------

// プレイヤークラス
function Player(){
	var rq = new Quaternion();
	var rmat = new Matrix();
	var action = 0;
	var rotate = 0;
	var speed = 0.005;
	this.height = 1;
	
	// 初期化
	this.init = function(){
		for(var i = 0; i < 10; i++){
			// 位置を決める
			var mat = new Matrix();
			var theta = Math.random() * Math.PI * 2;
			var phi = Math.random() * Math.PI;
			rq.identity();
			rq.mulRot(phi, 0, 0, 1);
			rq.mulRot(theta, 0, 1, 0);
			mat.qRotate(rq);
			this.height = sphia.getHeight(mat);
			// 水上っぽいならやり直し
			if(this.height > 1){break;}
		}
	}
	
	// ----------------------------------------------------------------
	// 計算
	this.calc = function(mat){
		action++;
		// キー入力による回転
		var c = Math.cos(ctrl.rotv);
		var s = Math.sin(ctrl.rotv);
		if     (ctrl.krt && ctrl.kup){rq.mulRot(speed,  c - s, 0,  s + c); rotate = Math.PI * 1.74 + ctrl.rotv;}
		else if(ctrl.klt && ctrl.kup){rq.mulRot(speed,  c + s, 0,  s - c); rotate = Math.PI * 1.26 + ctrl.rotv;}
		else if(ctrl.klt && ctrl.kdn){rq.mulRot(speed, -c + s, 0, -s - c); rotate = Math.PI * 0.74 + ctrl.rotv;}
		else if(ctrl.krt && ctrl.kdn){rq.mulRot(speed, -c - s, 0, -s + c); rotate = Math.PI * 0.26 + ctrl.rotv;}
		else if(ctrl.krt){rq.mulRot(speed, -s, 0,  c); rotate = Math.PI * 0.0 + ctrl.rotv;}
		else if(ctrl.kup){rq.mulRot(speed,  c, 0,  s); rotate = Math.PI * 1.5 + ctrl.rotv;}
		else if(ctrl.klt){rq.mulRot(speed,  s, 0, -c); rotate = Math.PI * 1.0 + ctrl.rotv;}
		else if(ctrl.kdn){rq.mulRot(speed, -c, 0, -s); rotate = Math.PI * 0.5 + ctrl.rotv;}
		else{action = 0;}
		// 引数の行列に回転を反映
		mat.qRotate(rq);
		// 逆行列を計算して自身の位置行列とする
		rmat.inverse(mat);
		
		// 高さ獲得と速度の調整
		var new_height = sphia.getHeight(mat);
		//if(new_height < 0.97){new_height = 0.97;}
		speed = Math.max(0.005 - Math.abs(new_height - this.height), 0);
		this.height = new_height;
	}
	
	// ----------------------------------------------------------------
	// 描画
	var tmpmat1 = new Matrix();
	var tmpmat2 = new Matrix();
	this.draw = function(character, e3d, wmat, pmat){
		tmpmat1.mul(rmat, wmat);
		tmpmat2.mul(tmpmat1, pmat);
		character.draw(e3d, tmpmat2, ctrl, rotate, action, 0, 0, this.height, 0.08);
	}
}

// ----------------------------------------------------------------
// ----------------------------------------------------------------
// ----------------------------------------------------------------

</script>
</head><body>
<!-- キャンバス -->
<canvas id='screen' width='320' height='320'></canvas><br>
</body></html>

